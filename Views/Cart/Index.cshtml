@using newltweb.DTOs.Cart
@model CartSnapshot

@{
    var crumbs = ViewBag.Breadcrumbs as List<(string Text, string Href)>;
}

@{
    ViewData["Title"] = "Cart";
    Layout = "~/Views/Shared/MyLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/style.css" />
    <link rel="stylesheet" href="~/css/shop-style.css" />
}

<main>
    <!-- Spinner Start -->
    <div id="spinner"
         class="show bg-white position-fixed translate-middle w-100 vh-100 top-50 start-50 d-flex align-items-center justify-content-center">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
    <!-- Spinner End -->
    <!-- Single Page Header start -->
    @if (crumbs != null && crumbs.Any())
    {
        <nav aria-label="breadcrumb" style="padding-left: 100px;">
            <ol class="breadcrumb justify-content-left">
                @foreach (var c in crumbs)
                {
                    if (!string.IsNullOrEmpty(c.Href))
                    {
                        <li class="breadcrumb-item"><a href="@c.Href">@c.Text</a></li>
                    }
                    else
                    {
                        <li class="breadcrumb-item active" aria-current="page">@c.Text</li>
                    }
                }
            </ol>
        </nav>
    }
    <!-- Single Page Header End -->
    <!-- Cart Page Start -->
    <div class="container-fluid py-5">
        <div class="container py-5">
            <div class="table-responsive">
                @* <form asp-action="Update" method="post" asp-antiforgery="true"> *@
                    <!--<table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Tên sách</th>
                                <th scope="col">Đơn giá</th>
                                <th scope="col">Số lượng</th>
                                <th scope="col">Tổng</th>
                                <th scope="col">Handle</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th scope="row">
                                    <p class="mb-0 py-4">Apple iPad Mini</p>
                                </th>
                                <td>
                                    <p class="mb-0 py-4">2.99 $</p>
                                </td>
                                <td>
                                    <div class="input-group quantity py-4" style="width: 100px;">
                                        <div class="input-group-btn">
                                            <button class="btn btn-sm btn-minus rounded-circle bg-light border">
                                                <i class="fa fa-minus"></i>
                                            </button>
                                        </div>
                                        <input type="text" class="form-control form-control-sm text-center border-0"
                                               value="1">
                                        <div class="input-group-btn">
                                            <button class="btn btn-sm btn-plus rounded-circle bg-light border">
                                                <i class="fa fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <p class="mb-0 py-4">2.99 $</p>
                                </td>
                                <td class="py-4">
                                    <button class="btn btn-md rounded-circle bg-light border">
                                        <i class="fa fa-times text-danger"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>-->
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Sách</th>
                                <th>Tác giả</th>
                                <th class="text-right">Đơn giá</th>
                                <th class="text-center">Số lượng</th>
                                <th class="text-right">Thành tiền</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Items.Count; i++)
                            {
                                var item = Model.Items[i];
                                @* <form asp-action="Update" method="post" asp-antiforgery="true"> *@
                                    <tr data-rowid="@item.MaSachGH">
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.Anh))
                                            {
                                                var raw = @item.Anh ?? "";
                                                var safeFile = Uri.EscapeDataString(raw) + ".jpg";
                                                var imgSrc = Url.Content("~/images/books/" + safeFile);
                                                
                                                <img src="@imgSrc" style="width:40px; height:60px;object-fit: cover;" />
                                            }
                                            @item.TenSach
                                        </td>
                                        <td class="text-right author">@item.TacGia</td>
                                        <td class="text-right">@(item.DonGiaBan is decimal d ? (d * 10000m).ToString("C", new System.Globalization.CultureInfo("vi-VN")) : "")</td>
                                        <td class="text-center">
                                            @* style="display:flex; gap:8px; align-items:center;" *@
                                            @* style="width:140px; margin:auto; *@
                                            <div class="input-group" style="display:flex; gap:8px; align-items:center;" ">
                                                <form asp-action="ChangeAmount" method="post" asp-antiforgery="true">
                                                    <input type="hidden" name="maSachGH" value="@item.MaSachGH" />
                                                    <input type="hidden" name="delta" value="-1"/>
                                                    <input type="hidden" name="amount" value="@item.SoLuong"/>
                                            <button type="submit" class="btn btn-outline-secondary btn-decrease" style="display:inline-block;padding:2px 6px;font-size:12px;line-height:2;border-radius:4px;">−</button>
                                        </form>

                                                    @item.SoLuong

                                                <form asp-action="ChangeAmount" method="post" asp-antiforgery="true">
                                                    <input type="hidden" name="maSachGH" value="@item.MaSachGH" />
                                                    <input type="hidden" name="delta" value="+1"/>
                                                    <input type="hidden" name="amount" value="@item.SoLuong" />
                                            <button type="submit" class="btn btn-outline-secondary btn-increase" style="display:inline-block;padding:2px 6px;font-size:12px;line-height:2;border-radius:4px;">+</button>
                                                </form>
                                            </div>
                                        </td>
                                        <td class="text-right line-total">@(item.TongTien is decimal tt ? (tt * 10000m).ToString("C", new System.Globalization.CultureInfo("vi-VN")) : "")</td>

                                    </tr>
                                @* </form> *@
                            }
                        </tbody>
                    </table>
                @* </form> *@
            </div>

            <div class="row">
                
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-6">Tổng giá trị sách</dt>
                        <dd class="col-sm-6 text-right" id="total-books">@(Model.TongGTSach is decimal tgt ? (tgt * 10000m).ToString("C", new System.Globalization.CultureInfo("vi-VN")) : "")</dd>

                        <dt class="col-sm-6">Phí ship</dt>
                        <dd class="col-sm-6 text-right" id="fee-ship">@(Model.PhiShip is decimal ps ? (ps * 10000m).ToString("C", new System.Globalization.CultureInfo("vi-VN")) : "")</dd>

                        <dt class="col-sm-6">Giảm giá</dt>
                        <dd class="col-sm-6 text-right" id="discount">-@(Model.GiamGia is decimal gg ? (gg * 10000m).ToString("C", new System.Globalization.CultureInfo("vi-VN")) : "")</dd>

                        <dt class="col-sm-6"><strong>Tổng</strong></dt>
                        <dd class="col-sm-6 text-right"><strong id="grand-total">@(Model.Tong is decimal tong ? (tong * 10000m).ToString("C", new System.Globalization.CultureInfo("vi-VN")) : "")</strong></dd>
                    </dl>
                </div>
                <form id="checkout-form" asp-action="Buy" method="post" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="cartId" value="@Model.MaGh" />
                    <button id="btn-buy" type="submit" class="btn btn-success" @(Model.Items.Count == 0 ? "disabled" : "")>Mua ngay</button>
                </form>
            </div>
        </div>
    </div>
    <!-- Cart Page End -->
    <!-- Back to Top -->
    @* <a href="#" class="btn btn-primary btn-lg-square back-to-top"><i class="fa fa-arrow-up"></i></a> *@
</main>


@section Scripts {
    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="~/lib/wow/wow.min.js"></script>
    <script src="~/lib/owlcarousel/owl.carousel.min.js"></script>

    <script type="text/javascript" src="~/js/script.js"></script>
    <script type="text/javascript" src="~/js/shop-script.js"></script>
}